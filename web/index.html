<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>mini-llm</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: url('/web/asif-aether-UmflEuFW7Cg-unsplash.jpg') no-repeat center center/cover;
      height: 100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      color:#fff;
      overflow:hidden;
    }
    .container {
      width: 90%;
      max-width: 700px;
      height: 90vh;
      display:flex;
      flex-direction:column;
      border-radius: 20px;
      backdrop-filter: blur(20px);
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      overflow:hidden;
    }
    header {
      padding: 16px;
      text-align: center;
      font-size: 1.3rem;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      position: relative;
    }
    .header-buttons {
      position: absolute;
      top: 10px;
      right: 10px;
      display:flex;
      gap:10px;
    }
    .header-buttons button {
      padding:8px 14px;
      border:none;
      border-radius:10px;
      background: rgba(255,255,255,0.15);
      color:#fff;
      font-size:0.9rem;
      cursor:pointer;
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,0.25);
      transition: all 0.2s ease;
    }
    .header-buttons button:hover { background: rgba(255,255,255,0.25); }

    #welcome {
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      transition: opacity 0.5s ease;
      padding:20px;
    }
    #chat {
      flex:1;
      overflow-y:auto;
      padding:20px;
      display:none;
    }

    .msg { display:flex; align-items:flex-end; gap:8px; margin:8px 0; }
    .bubble {
      max-width:75%;
      padding:12px 16px;
      border-radius:16px;
      line-height:1.5;
      white-space:pre-wrap;
      backdrop-filter: blur(15px);
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      animation: fadeIn 0.3s ease;
    }
    .user { flex-direction: row-reverse; }
    .user .bubble { border-radius:16px 16px 0 16px; }
    .bot .bubble  { border-radius:16px 16px 16px 0; }

    .avatar {
      width:28px; height:28px;
      border-radius:50%;
      background:#444;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
    }


    .meta {
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:8px;
      font-size:12px;
      color:#d6d6db;
      opacity:.9;
    }
    .chip {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.08);
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, border-color .15s ease;
    }
    .chip:hover { background: rgba(255,255,255,0.16); border-color: rgba(255,255,255,0.35); }
    .reason {
      display:none;
      margin-top:8px;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.18);
      color:#e9e9ef;
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .spinner {
      width:12px; height:12px;
      border:2px solid #bbb; border-top-color: transparent;
      border-radius:50%;
      display:inline-block;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }

    #form {
      display:flex;
      padding:16px;
      border-top:1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
    }
    #input, #start-input {
      flex:1;
      padding:12px 16px;
      border:none;
      border-radius:12px;
      font-size:1rem;
      outline:none;
      background: rgba(255,255,255,0.15);
      color:#fff;
      border:1px solid rgba(255,255,255,0.3);
      resize: none;
      min-height: 60px;
      max-height: 200px;
      overflow-y: auto;
    }
    #input::placeholder, #start-input::placeholder { color: #ccc; }

    button {
      margin-left:10px;
      padding:12px 18px;
      border:none;
      border-radius:12px;
      background: rgba(59,130,246,0.8);
      color:white;
      font-size:1rem;
      font-weight:500;
      cursor:pointer;
      transition: all 0.2s ease;
    }
    button:hover { background: rgba(37,99,235,0.9); }

    @keyframes fadeIn {
      from { opacity:0; transform:translateY(6px); }
      to { opacity:1; transform:translateY(0); }
    }

    .dots { display:flex; gap:4px; align-items:center; justify-content:center; }
    .dot { width:6px; height:6px; border-radius:50%; background:#fff; animation: bounce 1s infinite; }
    .dot:nth-child(2){ animation-delay:0.2s; }
    .dot:nth-child(3){ animation-delay:0.4s; }
    @keyframes bounce { 0%,80%,100% { transform: scale(0.7); opacity:0.7; } 40% { transform: scale(1); opacity:1; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      mini-llm
      <div class="header-buttons">
        <button id="historyBtn">history</button>
        <button id="newChatBtn">new chat</button>
      </div>
    </header>

    <div id="welcome">
      <h1> hey there</h1><br>
      <p>your lightweight model is ready. type something to begin.</p><br>
      <form id="start-form" style="width:100%; max-width:400px;">
        <input id="start-input" placeholder="say hello..." autocomplete="off">
      </form>
    </div>

    <div id="chat"></div>

    <form id="form" style="display:none;">
      <textarea id="input" placeholder="type your message..." autocomplete="off"></textarea>
      <button type="submit">Send</button>
    </form>
  </div>

  <script>
    const welcome = document.getElementById('welcome');
    const chat = document.getElementById('chat');
    const startForm = document.getElementById('start-form');
    const startInput = document.getElementById('start-input');
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const historyBtn = document.getElementById('historyBtn');
    const newChatBtn = document.getElementById('newChatBtn');

    function addMsg(text, cls, isLoader=false) {
      const div = document.createElement('div');
      div.className = 'msg ' + cls;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = cls === 'user' ? 'ðŸ§‘' : 'ðŸ¤–';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      if (isLoader) {
        const dots = document.createElement('div'); dots.className = 'dots';
        dots.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
        bubble.appendChild(dots);
      } else {
        bubble.textContent = text;
      }

      div.appendChild(avatar);
      div.appendChild(bubble);
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;

      return { wrapper: div, bubble };
    }

    function attachThinkingUI(bubbleEl, reasoningText) {
      
      const meta = document.createElement('div');
      meta.className = 'meta';

      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.innerHTML = '<span class="spinner"></span> thinkingâ€¦';
      meta.appendChild(chip);

      
      const reason = document.createElement('div');
      reason.className = 'reason';
      reason.textContent = reasoningText || 'no short reasoning provided';

      
      bubbleEl.appendChild(meta);
      bubbleEl.appendChild(reason);

      
      setTimeout(()=>{ chip.innerHTML = 'thinking'; }, 80);

      chip.addEventListener('click', () => {
        const open = reason.style.display === 'block';
        reason.style.display = open ? 'none' : 'block';
      });
    }

    async function sendMessage(text) {
      
      addMsg(text, 'user');

      
      const loader = addMsg('', 'bot', true);

      try {
        const res = await fetch('/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({prompt: text})
        });
        const data = await res.json();

        
        loader.bubble.innerHTML = data.reply || '(no reply)';
        
        attachThinkingUI(loader.bubble, data.reasoning_summary || '');

        saveHistory(text, data.reply, data.reasoning_summary || '');
      } catch (err) {
        loader.bubble.textContent = 'error talking to server.';
      } finally {
        chat.scrollTop = chat.scrollHeight;
      }
    }

    function saveHistory(prompt, reply, reasoning=''){
      const hist = JSON.parse(localStorage.getItem('chatHist') || '[]');
      hist.push({p:prompt, r:reply, t:reasoning});
      localStorage.setItem('chatHist', JSON.stringify(hist));
    }

    function loadHistory(){
      chat.innerHTML = '';
      const hist = JSON.parse(localStorage.getItem('chatHist') || '[]');
      hist.forEach(h=>{
        addMsg(h.p,'user');
        const bot = addMsg(h.r,'bot');
        attachThinkingUI(bot.bubble, h.t || '');
      });
    }

    startForm.onsubmit = (e) => {
      e.preventDefault();
      const text = startInput.value.trim();
      if (!text) return;
      welcome.style.display = 'none';
      chat.style.display = 'block';
      form.style.display = 'flex';
      input.focus();
      sendMessage(text);
    };

    form.onsubmit = (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      sendMessage(text);
    };

    historyBtn.onclick = () => {
      welcome.style.display = 'none';
      chat.style.display = 'block';
      form.style.display = 'flex';
      loadHistory();
    };

    newChatBtn.onclick = () => {
      localStorage.removeItem('chatHist');
      chat.innerHTML = '';
      welcome.style.display = 'flex';
      chat.style.display = 'none';
      form.style.display = 'none';
    };

    loadHistory();
  </script>
</body>
</html>
